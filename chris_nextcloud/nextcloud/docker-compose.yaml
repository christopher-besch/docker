# based on https://linuxhandbook.com/install-nextcloud-docker
version: "3.7"

services:

    NCDatabase:
        image: "mariadb:10.7.4"
        
        volumes:
          - "${NC_PATH}/nc_maria_db:/var/lib/mysql"

        environment:
            - MYSQL_RANDOM_ROOT_PASSWORD=1
            # - MYSQL_ROOT_PASSWORD
            - MYSQL_DATABASE=NC
            - MYSQL_USER=nextcloud
            - MYSQL_PASSWORD
            # stop when backup is being made
            - CRON_TIME=${BACKUP_CRON}
            # SIGTERM
            - CRON_SIGNAL=0xf

        # accept SIGTERM
        restart: "unless-stopped"
        networks: ["common"]

    NCFrontend:
        image: "nextcloud:24.0.3"

        volumes: 
          - "${NC_PATH}/nc_data:/var/www/html"

        environment:
            - LETSENCRYPT_HOST=${DOMAIN}
            - VIRTUAL_HOST=${DOMAIN}
            - TRUSTED_PROXIES
            - OVERWRITEPROTOCOL
            - MYSQL_DATABASE=NC
            - MYSQL_USER=nextcloud
            - MYSQL_PASSWORD
            - MYSQL_HOST=NCDatabase
            - NEXTCLOUD_TRUSTED_DOMAINS=${DOMAIN}
            # stop when backup is being made
            - CRON_TIME=${BACKUP_CRON}
            # SIGTERM
            - CRON_SIGNAL=0xf

        depends_on:
            - "NCDatabase"
        # accept SIGTERM
        restart: "unless-stopped"
        networks: ["net", "common"]

    BorgBackup:
        image: chrisbesch/borg_backup
        build: ./borg_backup
        environment:
            - CRON_TIME=${BACKUP_CRON}
            - BACKUP_ORIGIN=${NC_PATH}
            - BORG_REPO
            - BORG_COMPRESSION
            - BORG_PREFIX
      
    DockerCron:
        image: chrisbesch/docker_cron
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock:rw"
        environment:
            - TZ=Europe/Berlin

networks:
    net:
        external: true
    common:
        internal: true

